---
title: "Visualizing JSON"
author: "Jeremy Stanley"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", fig.width = 7, fig.height = 5)
options(dplyr.print_min = 4L, dplyr.print_max = 4L)
```

## Load required libraries

```{r, message = FALSE}
library(tidyjson)   # this library
library(dplyr)      # for %>% and other dplyr functions
library(ggplot2)    # for plotting
library(igraph)     # for graph visualizations
library(RColorBrewer) # for colors
library(jsonlite)   # for fromJSON
library(purrr)      # for list operations
library(wordcloud)
library(magrittr)
```

## Companies Data

Let's work with a sample of the companies data

```{r}
set.seed(1)
samp_co <- companies[sample(1:length(companies), 50)]
```

We can see the structure of a sample record with `str`

```{r}
str(fromJSON(samp_co[[1]]))
```

Alternatively, we can compute the structure using `tidyjson::json_structure`

```{r}
structure <- companies %>% json_structure

keys <- structure %>% 
  filter(type != "null" & !is.na(key)) %>%
  group_by(level, key, type) %>%
  summarize(ndoc = n_distinct(document.id))

keys
```

As a word cloud

```{r}
keys %$% wordcloud(key, ndoc, scale = c(1.5, .1), min.freq = 100)
```

In ggplot2

```{r, fig.height = 12}
keys %>%
  ggplot(aes(ndoc, key, colour = type)) +
    geom_segment(aes(xend = 0, yend = key)) +
    facet_grid(level ~ ., scale = "free_y", space = "free", switch = 'y')
```

Plot as a network graph

```{r}
plot_structure_graph <- function(json, legend = TRUE) {
  
  structure <- json %>% json_structure
  
  type_colors <- brewer.pal(6, "Accent")

  g <- graph_from_data_frame(
    structure %>%
      filter(!is.na(parent.id)) %>%
      select(parent.id, child.id),
    directed = TRUE,
    vertices = structure %>% 
      transmute(child.id, 
                vertex.color = type_colors[as.integer(type)],
                vertex.label = ifelse(type %in% c("object", "array") & length > 0,
                                      key, NA_character_)))
  
  op <- par(mar = c(0, 0, 0, 0))
  plot(g, edge.arrow.size = .1, vertex.color = V(g)$vertex.color, vertex.size = 4,
       vertex.label = V(g)$vertex.label, layout = layout_with_kk, 
       edge.color = 'grey70', edge.width = 2)
  
  if (legend)
    legend(x = -1.3, y = -.6, levels(structure$type), pch = 21,
           col="#777777", pt.bg = type_colors, 
           pt.cex = 2, cex = .8, bty = "n", ncol = 1)
  
  par(op)
  
  NULL
  
}
```

Plot a single company

```{r}
samp_co[[1]] %>% plot_structure_graph
```

A lot of variety

```{r}
nrow <- 3
ncol <- 4
op <- par(mfrow = c(nrow, ncol))
walk(samp_co[1:(nrow*ncol)], plot_structure_graph, legend = FALSE)
par(op)
```

The most complex

```{r}
lengths <- companies %>% 
  map(fromJSON, simplifyVector = FALSE) %>%
  map(unlist, recursive = TRUE) %>%
  map_int(length)
most_complex <- companies[which(lengths == max(lengths))]

most_complex %>% spread_values(name = jstring("name")) %>% extract2("name")
``` 

Let's try to plot it!

```{r}
plot_structure_graph(most_complex)
```

That is just too big, let's simplify things

```{r, fig.height = 8}
sub_objects <- most_complex %>%
  gather_keys %>%
  json_types %>%
  json_lengths %>%
  filter(length > 1)

nrow <- 5
ncol <- 3
op <- par(mfrow = c(nrow, ncol))
for(i in 1:nrow(sub_objects)) {
  plot_structure_graph(sub_objects[i, ], legend = FALSE)
  title(sub_objects$key[i], col.main = 'red')
}
par(op)
```
